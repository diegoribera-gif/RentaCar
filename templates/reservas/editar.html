{% extends 'base.html' %}

{% block title %}Editar Reserva - RentaCar{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-edit me-2"></i>Editar Reserva</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'detalle_reserva' reserva.id %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>Cancelar
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header bg-warning">
                <h5 class="card-title mb-0">Editar Reserva: {{ reserva.codigo_reserva }}</h5>
            </div>
            <div class="card-body">
                <form method="post" id="reservaForm">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-warning border-bottom pb-2">Datos del Cliente</h6>
                            
                            <div class="mb-3">
                                <label class="form-label">Cliente*</label>
                                {{ form.cliente }}
                                {% if form.cliente.errors %}
                                    <div class="text-danger small">{{ form.cliente.errors }}</div>
                                {% endif %}
                                <div class="form-text">Selecciona un cliente con licencia válida</div>
                            </div>
                            
                            <!-- Información del Cliente Seleccionado -->
                            <div id="clienteInfo" class="card bg-light mb-3" 
                                 style="display: {% if reserva.cliente %}block{% else %}none{% endif %};">
                                <div class="card-body py-2">
                                    <h6 class="card-title mb-1">Información del Cliente</h6>
                                    <div class="row small">
                                        <div class="col-6">
                                            <strong>CI:</strong> <span id="clienteCI">{{ reserva.cliente.cedula_identidad }}</span>
                                        </div>
                                        <div class="col-6">
                                            <strong>Licencia:</strong> <span id="clienteLicencia">{{ reserva.cliente.licencia_conducir }}</span>
                                        </div>
                                        <div class="col-6">
                                            <strong>Teléfono:</strong> <span id="clienteTelefono">{{ reserva.cliente.telefono }}</span>
                                        </div>
                                        <div class="col-6">
                                            <strong>Estado:</strong> 
                                            <span id="clienteEstado" class="badge bg-{% if reserva.cliente.licencia_valida %}success{% else %}danger{% endif %}">
                                                {% if reserva.cliente.licencia_valida %}Válida{% else %}Vencida{% endif %}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-warning border-bottom pb-2">Fechas de Reserva</h6>
                            
                            <div class="mb-3">
                                <label class="form-label">Fecha y Hora de Inicio*</label>
                                {{ form.fecha_inicio }}
                                {% if form.fecha_inicio.errors %}
                                    <div class="text-danger small">{{ form.fecha_inicio.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Fecha y Hora de Fin*</label>
                                {{ form.fecha_fin }}
                                {% if form.fecha_fin.errors %}
                                    <div class="text-danger small">{{ form.fecha_fin.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="alert alert-info py-2">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Duración:</strong> <span id="duracionDias">{{ reserva.dias }}</span> días
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="text-warning border-bottom pb-2">Selección de Vehículo</h6>
                            
                            <div class="mb-3">
                                <label class="form-label">Vehículo*</label>
                                {{ form.vehiculo }}
                                {% if form.vehiculo.errors %}
                                    <div class="text-danger small">{{ form.vehiculo.errors }}</div>
                                {% endif %}
                                <div class="form-text">Solo se muestran vehículos disponibles</div>
                            </div>
                            
                            <!-- Información del Vehículo Seleccionado -->
                            <div id="vehiculoInfo" class="card bg-light mb-3" 
                                 style="display: {% if reserva.vehiculo %}block{% else %}none{% endif %};">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3 text-center">
                                            <div id="vehiculoImagen" class="bg-secondary rounded d-flex align-items-center justify-content-center" 
                                                 style="width: 100px; height: 80px;">
                                                {% if reserva.vehiculo.imagen %}
                                                <img src="{{ reserva.vehiculo.imagen.url }}" alt="{{ reserva.vehiculo.marca }} {{ reserva.vehiculo.modelo }}" 
                                                     style="width: 100%; height: 100%; object-fit: cover;" class="rounded">
                                                {% else %}
                                                <i class="fas fa-car text-white fa-2x"></i>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-9">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <strong>Marca/Modelo:</strong> 
                                                    <span id="vehiculoModelo">{{ reserva.vehiculo.marca }} {{ reserva.vehiculo.modelo }}</span><br>
                                                    <strong>Tipo:</strong> 
                                                    <span id="vehiculoTipo">{{ reserva.vehiculo.get_tipo_display }}</span><br>
                                                    <strong>Año:</strong> 
                                                    <span id="vehiculoAnio">{{ reserva.vehiculo.año }}</span>
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>Capacidad:</strong> 
                                                    <span id="vehiculoCapacidad">{{ reserva.vehiculo.capacidad_pasajeros }}</span> pasajeros<br>
                                                    <strong>Precio/Día:</strong> 
                                                    <span id="vehiculoPrecio" class="text-success">Bs. {{ reserva.vehiculo.precio_dia }}</span><br>
                                                    <strong>Total:</strong> 
                                                    <span id="vehiculoTotal" class="text-success h5">Bs. {{ reserva.precio_total }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="text-warning border-bottom pb-2">Información Adicional</h6>
                            
                            <div class="mb-3">
                                <label class="form-label">Estado*</label>
                                {{ form.estado }}
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Precio Total (Bs.)*</label>
                                {{ form.precio_total }}
                                <div class="form-text">Actualizar si hubo cambios en las fechas o vehículo</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Observaciones</label>
                                {{ form.observaciones }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resumen de la Reserva -->
                    <div class="card mt-4 bg-light">
                        <div class="card-header">
                            <h6 class="card-title mb-0">Resumen de la Reserva</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="border rounded p-3">
                                        <i class="fas fa-user text-primary fa-2x mb-2"></i>
                                        <div class="small">Cliente</div>
                                        <strong id="resumenCliente">{{ reserva.cliente.usuario.get_full_name }}</strong>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-3">
                                        <i class="fas fa-car text-success fa-2x mb-2"></i>
                                        <div class="small">Vehículo</div>
                                        <strong id="resumenVehiculo">{{ reserva.vehiculo.marca }} {{ reserva.vehiculo.modelo }}</strong>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-3">
                                        <i class="fas fa-calendar text-warning fa-2x mb-2"></i>
                                        <div class="small">Duración</div>
                                        <strong id="resumenDuracion">{{ reserva.dias }} días</strong>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-3">
                                        <i class="fas fa-dollar-sign text-danger fa-2x mb-2"></i>
                                        <div class="small">Total</div>
                                        <strong id="resumenTotal" class="h5">Bs. {{ reserva.precio_total }}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                        <a href="{% url 'detalle_reserva' reserva.id %}" class="btn btn-secondary">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Datos de clientes y vehículos
    const clientesData = {
        {% for cliente in form.cliente.field.queryset %}
        {{ cliente.id }}: {
            nombre: "{{ cliente.usuario.get_full_name }}",
            ci: "{{ cliente.cedula_identidad }}",
            licencia: "{{ cliente.licencia_conducir }}",
            telefono: "{{ cliente.telefono }}",
            licenciaValida: {{ cliente.licencia_valida|yesno:"true,false" }}
        },
        {% endfor %}
    };
    
    const vehiculosData = {
        {% for vehiculo in form.vehiculo.field.queryset %}
        {{ vehiculo.id }}: {
            modelo: "{{ vehiculo.marca }} {{ vehiculo.modelo }}",
            tipo: "{{ vehiculo.get_tipo_display }}",
            anio: "{{ vehiculo.año }}",
            capacidad: "{{ vehiculo.capacidad_pasajeros }}",
            precio: parseFloat("{{ vehiculo.precio_dia }}"),
            imagen: "{% if vehiculo.imagen %}{{ vehiculo.imagen.url }}{% endif %}"
        },
        {% endfor %}
    };
    
    // Inicializar con los datos actuales
    const clienteActualId = "{{ reserva.cliente.id }}";
    const vehiculoActualId = "{{ reserva.vehiculo.id }}";
    
    // Eventos para actualizar información en tiempo real
    document.getElementById('id_cliente').addEventListener('change', function() {
        const clienteId = this.value;
        const infoDiv = document.getElementById('clienteInfo');
        
        if (clienteId && clientesData[clienteId]) {
            const cliente = clientesData[clienteId];
            document.getElementById('clienteCI').textContent = cliente.ci;
            document.getElementById('clienteLicencia').textContent = cliente.licencia;
            document.getElementById('clienteTelefono').textContent = cliente.telefono;
            
            const estadoBadge = document.getElementById('clienteEstado');
            estadoBadge.textContent = cliente.licenciaValida ? 'Válida' : 'Vencida';
            estadoBadge.className = cliente.licenciaValida ? 'badge bg-success' : 'badge bg-danger';
            
            document.getElementById('resumenCliente').textContent = cliente.nombre;
            infoDiv.style.display = 'block';
        } else {
            infoDiv.style.display = 'none';
            document.getElementById('resumenCliente').textContent = '-';
        }
    });
    
    document.getElementById('id_vehiculo').addEventListener('change', function() {
        const vehiculoId = this.value;
        const infoDiv = document.getElementById('vehiculoInfo');
        
        if (vehiculoId && vehiculosData[vehiculoId]) {
            const vehiculo = vehiculosData[vehiculoId];
            document.getElementById('vehiculoModelo').textContent = vehiculo.modelo;
            document.getElementById('vehiculoTipo').textContent = vehiculo.tipo;
            document.getElementById('vehiculoAnio').textContent = vehiculo.anio;
            document.getElementById('vehiculoCapacidad').textContent = vehiculo.capacidad;
            document.getElementById('vehiculoPrecio').textContent = `Bs. ${vehiculo.precio.toFixed(2)}`;
            
            const imagenDiv = document.getElementById('vehiculoImagen');
            if (vehiculo.imagen) {
                imagenDiv.innerHTML = `<img src="${vehiculo.imagen}" alt="${vehiculo.modelo}" 
                                      style="width: 100%; height: 100%; object-fit: cover;" class="rounded">`;
            } else {
                imagenDiv.innerHTML = '<i class="fas fa-car text-white fa-2x"></i>';
            }
            
            document.getElementById('resumenVehiculo').textContent = vehiculo.modelo;
            calcularTotal();
            infoDiv.style.display = 'block';
        } else {
            infoDiv.style.display = 'none';
            document.getElementById('resumenVehiculo').textContent = '-';
        }
    });
    
    // Calcular duración y total
    function calcularDuracion() {
        const inicio = document.getElementById('id_fecha_inicio').value;
        const fin = document.getElementById('id_fecha_fin').value;
        
        if (inicio && fin) {
            const inicioDate = new Date(inicio);
            const finDate = new Date(fin);
            const diffTime = Math.abs(finDate - inicioDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            document.getElementById('duracionDias').textContent = diffDays;
            document.getElementById('resumenDuracion').textContent = `${diffDays} día${diffDays !== 1 ? 's' : ''}`;
            calcularTotal(diffDays);
        }
    }
    
    function calcularTotal(dias) {
        const vehiculoId = document.getElementById('id_vehiculo').value;
        if (vehiculoId && vehiculosData[vehiculoId] && dias) {
            const precio = vehiculosData[vehiculoId].precio;
            const total = precio * dias;
            
            document.getElementById('vehiculoTotal').textContent = `Bs. ${total.toFixed(2)}`;
            document.getElementById('resumenTotal').textContent = `Bs. ${total.toFixed(2)}`;
            
            // Actualizar campo de precio total en el formulario
            document.getElementById('id_precio_total').value = total.toFixed(2);
        }
    }
    
    document.getElementById('id_fecha_inicio').addEventListener('change', calcularDuracion);
    document.getElementById('id_fecha_fin').addEventListener('change', calcularDuracion);
    document.getElementById('id_vehiculo').addEventListener('change', calcularDuracion);
    
    // Inicializar cálculo
    calcularDuracion();
    
    // Validar que fecha fin no sea menor que fecha inicio
    document.getElementById('id_fecha_fin').addEventListener('change', function() {
        const fechaInicio = document.getElementById('id_fecha_inicio').value;
        const fechaFin = this.value;
        
        if (fechaInicio && fechaFin && fechaFin < fechaInicio) {
            alert('La fecha de fin no puede ser anterior a la fecha de inicio.');
            this.value = '';
        }
    });
});
</script>

<style>
    input, select, textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    input:focus, select:focus, textarea:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        outline: none;
    }
    .form-label {
        font-weight: 500;
        margin-bottom: 5px;
    }
</style>
{% endblock %}