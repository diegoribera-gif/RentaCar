{% extends 'base.html' %}

{% block title %}Disponibilidad de Vehículos - RentaCar{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-calendar-check me-2"></i>Disponibilidad de Vehículos</h1>
    {% if user_role == 'administrador' or user_role == 'empleado' %}
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'lista_vehiculos' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Volver a la Lista
        </a>
    </div>
    {% endif %}
</div>

<!-- Filtro de fechas -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="card-title mb-0">Consultar Disponibilidad</h5>
    </div>
    <div class="card-body">
        <form method="get" id="filtroForm">
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Fecha de Inicio</label>
                        <input type="date" class="form-control" name="fecha_inicio" 
                               id="fecha_inicio" value="{{ fecha_inicio }}" required>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Fecha de Fin</label>
                        <input type="date" class="form-control" name="fecha_fin" 
                               id="fecha_fin" value="{{ fecha_fin }}" required>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-2"></i>Consultar Disponibilidad
                        </button>
                    </div>
                </div>
            </div>
        </form>
        
        <!-- API en tiempo real (solo para clientes) -->
        {% if user_role == 'cliente' %}
        <div class="mt-3">
            <button type="button" class="btn btn-outline-info" id="verDisponibilidadReal">
                <i class="fas fa-sync-alt me-2"></i>Ver Disponibilidad en Tiempo Real
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Resultados -->
<div class="row" id="resultadosContainer">
    {% if fecha_inicio and fecha_fin %}
    <div class="col-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Mostrando vehículos disponibles desde <strong>{{ fecha_inicio }}</strong> hasta <strong>{{ fecha_fin }}</strong>
        </div>
    </div>
    
    {% if vehiculos %}
        {% for vehiculo in vehiculos %}
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                {% if vehiculo.imagen %}
                <img src="{{ vehiculo.imagen.url }}" class="card-img-top" alt="{{ vehiculo.marca }} {{ vehiculo.modelo }}" style="height: 200px; object-fit: cover;">
                {% else %}
                <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center" style="height: 200px;">
                    <i class="fas fa-car fa-4x text-light"></i>
                </div>
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">{{ vehiculo.marca }} {{ vehiculo.modelo }}</h5>
                    <h6 class="card-subtitle mb-2 text-muted">{{ vehiculo.placa }}</h6>
                    
                    <ul class="list-unstyled mb-3">
                        <li><i class="fas fa-calendar me-2"></i> Año: {{ vehiculo.año }}</li>
                        <li><i class="fas fa-users me-2"></i> Capacidad: {{ vehiculo.capacidad_pasajeros }} pasajeros</li>
                        <li><i class="fas fa-tag me-2"></i> Tipo: {{ vehiculo.get_tipo_display }}</li>
                        <li><i class="fas fa-dollar-sign me-2"></i> Precio/día: Bs. {{ vehiculo.precio_dia }}</li>
                    </ul>
                    
                    <div class="mb-3">
                        <span class="badge bg-{% if vehiculo.estado == 'DISPONIBLE' %}success{% elif vehiculo.estado == 'MANTENIMIENTO' %}warning{% else %}danger{% endif %}">
                            {{ vehiculo.get_estado_display }}
                        </span>
                    </div>
                    
                    {% if user_role == 'cliente' %}
                    <a href="{% url 'crear_reserva' %}?vehiculo_id={{ vehiculo.id }}&fecha_inicio={{ fecha_inicio }}&fecha_fin={{ fecha_fin }}" 
                       class="btn btn-primary w-100">
                        <i class="fas fa-calendar-plus me-2"></i>Reservar Ahora
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="col-12">
        <div class="alert alert-warning text-center">
            <i class="fas fa-exclamation-triangle me-2"></i>
            No hay vehículos disponibles para las fechas seleccionadas.
        </div>
    </div>
    {% endif %}
    
    {% else %}
    <div class="col-12">
        <div class="alert alert-light text-center">
            <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">Selecciona un rango de fechas</h4>
            <p class="text-muted">Ingresa las fechas de inicio y fin para ver los vehículos disponibles.</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- Contenedor para resultados en tiempo real (solo clientes) -->
{% if user_role == 'cliente' %}
<div class="row mt-4" id="disponibilidadRealContainer" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">Disponibilidad en Tiempo Real</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="tablaDisponibilidadReal">
                        <thead>
                            <tr>
                                <th>Vehículo</th>
                                <th>Placa</th>
                                <th>Tipo</th>
                                <th>Precio/Día</th>
                                <th>Disponibilidad</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoTablaDisponibilidad">
                            <!-- Los datos se cargarán aquí por JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if user_role == 'cliente' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnDisponibilidadReal = document.getElementById('verDisponibilidadReal');
    const containerReal = document.getElementById('disponibilidadRealContainer');
    const cuerpoTabla = document.getElementById('cuerpoTablaDisponibilidad');
    
    btnDisponibilidadReal.addEventListener('click', function() {
        const fechaInicio = document.getElementById('fecha_inicio').value;
        const fechaFin = document.getElementById('fecha_fin').value;
        
        if (!fechaInicio || !fechaFin) {
            alert('Por favor, selecciona ambas fechas primero.');
            return;
        }
        
        // Mostrar cargando
        cuerpoTabla.innerHTML = `
            <tr>
                <td colspan="6" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Consultando disponibilidad...</p>
                </td>
            </tr>`;
        
        containerReal.style.display = 'block';
        
        // Hacer petición a la API
        fetch(`/api/disponibilidad/?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    cuerpoTabla.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-danger">
                                <i class="fas fa-exclamation-circle me-2"></i>${data.error}
                            </td>
                        </tr>`;
                    return;
                }
                
                if (data.vehiculos.length === 0) {
                    cuerpoTabla.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                <i class="fas fa-car me-2"></i>No hay vehículos disponibles para estas fechas.
                            </td>
                        </tr>`;
                    return;
                }
                
                // Mostrar resultados
                let html = '';
                data.vehiculos.forEach(vehiculo => {
                    html += `
                    <tr>
                        <td>${vehiculo.marca} ${vehiculo.modelo}</td>
                        <td>${vehiculo.placa}</td>
                        <td>${vehiculo.tipo}</td>
                        <td>Bs. ${vehiculo.precio_dia}</td>
                        <td>
                            <span class="badge bg-success">Disponible</span>
                        </td>
                        <td>
                            <a href="/reservas/crear/?vehiculo_id=${vehiculo.id}&fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}" 
                               class="btn btn-sm btn-primary">
                                <i class="fas fa-calendar-plus me-1"></i>Reservar
                            </a>
                        </td>
                    </tr>`;
                });
                
                cuerpoTabla.innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                cuerpoTabla.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>Error al consultar disponibilidad.
                        </td>
                    </tr>`;
            });
    });
    
    // Validar que fecha fin no sea menor que fecha inicio
    document.getElementById('fecha_fin').addEventListener('change', function() {
        const fechaInicio = document.getElementById('fecha_inicio').value;
        const fechaFin = this.value;
        
        if (fechaInicio && fechaFin && fechaFin < fechaInicio) {
            alert('La fecha de fin no puede ser anterior a la fecha de inicio.');
            this.value = '';
        }
    });
});
</script>
{% endif %}

<style>
.card-img-top {
    transition: transform 0.3s;
}
.card:hover .card-img-top {
    transform: scale(1.05);
}
</style>
{% endblock %}